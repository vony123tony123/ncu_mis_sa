<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Manager_Editor</title>
<link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
<link href="statics/icon/favicon.ico" type="image/x-icon"
	rel="shortcut icon">
<link rel="stylesheet" type="text/css"
	href="statics/css/cake.generic.css">
<script src="statics/js/jquery-3.4.1.min.js"></script>

   <!-- Bootstrap core CSS -->
<link href="statics/css/bootstrap.min.css" rel="stylesheet">
<link href="statics/css/font-awesome.min.css" rel="stylesheet">
<link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
<link href="statics/icon/favicon.ico" type="image/x-icon"
	rel="shortcut icon">

<!-- Custom styles for this template -->
<link href="statics/css/product.css" rel="stylesheet">
<link href="statics/css/jquery-confirm.css" rel="stylesheet">

<script src="statics/js/jquery-3.4.1.min.js"></script>
<script src="statics/js/jquery-confirm.js"></script>

</head>
<!--
	//程式未完成
	//表單選項問題未解決
-->
<body>
	<div style="display:none;" id="manager_bar">
		<div
			class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 border-bottom shadow-sm"
			style="background-color: LightGray; " >
			<img src="./statics/img/youtbue.png"
				style="width: 40px; height: 30px;">
			<h5 class="my-0 mr-md-auto font-weight-normal">OOO保險公司</h5>
			<nav class="my-2 my-md-0 mr-md-3">
				<a  class="p-2 text-dark" href="memberIndex.html">會員管理</a> <a
					class="p-2 text-dark" href="insuranceIndex.html">保險管理</a> <a
					class="p-2 text-dark" href="insurancePolicyIndex.html">保單管理</a>
				<a class="btn btn-outline-primary" href="login.html">登出</a>
			</nav>
		</div>
	</div>
	
	<div style=" display:none; "  id="member_bar">
		<div
			class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 border-bottom shadow-sm"
			style="background-color: LightGray;">
			<img src="./statics/img/youtbue.png"
				style="width: 40px; height: 30px;">
			<h5 class="my-0 mr-md-auto font-weight-normal">OOO保險公司</h5>
			<nav class="my-2 my-md-0 mr-md-3">
				<a class="p-2 text-dark" href="myMember.html">我的資訊</a> <a
					class="p-2 text-dark" href="insurance.html">保險列表</a> <a
					class="p-2 text-dark" href="insurancePolicyView_Member.html">我的保單</a>
			</nav>
			<a class="btn btn-outline-primary" href="login.html">登出</a>
		</div>
	</div>
	
	<div id="container">

		<div id="content">

			<h2>會員資料修改</h2>
			
			<!-- 提示 -->
			<div id="flashMessage" class="message" style="display: none;"></div>


			<!-- 表單：編輯會員之修改表單 -->
			<form id="form" accept-charset="utf-8">

				<div style="display: none;">
					<input type="hidden" name="_method" value="POST">

				</div>

				<div class="input name required">
					<label for="name">姓名</label> <input name="member_name"
						maxlength="30" type="text" id="name" required="required">
				</div>

				<div class="input email required">
					<label for="email">電郵</label> <input name="member_email"
						maxlength="50" type="email" id="email" required="required">
				</div>

				<div class="input password required">
					<label for="password">密碼</label> <input name="member_password"
						type="password" id="password" required="required">
				</div>

				<div class="input password_check required">
					<label for="member_password_check">密碼確認</label> <input
						name="password_check" maxlength="50" type="password"
						id="member_password_check" required="required">
				</div>

				<div class="input bank_account required">
					<label for="bank_account">銀行帳號</label> <input
						name="member_bank_account" maxlength="16" type="text"
						id="bank_account" required="required">
				</div>

				<div class="input birthday required">
					<label for="birthday">生日</label> <input name="member_birthday"
						maxlength="8" type="text" id="birthday" required="required">
				</div>

				<div class="input gender required">
					<label for="gender">性別</label>
					<div>
						<input name="member_gender" type="radio" id="gender_1" value="1"
							required="required">生理男
					</div>
					<div>
						<input name="member_gender" type="radio" id="gender_0" value="0"
							required="required">生理女
					</div>
				</div>

				<div class="input height required">
					<label for="height">身高</label> <input name="member_height"
						maxlength="3" type="text" id="height" required="required">
				</div>

				<div class="input weight required">
					<label for="weight">體重</label> <input name="member_weight"
						maxlength="3" type="text" id="weight" required="required">
				</div>

				<div class="input disease_id required">
					<label for="disease_id">疾病</label>
					<div>
						<input name="member_disease_id" type="radio" id="disease_id_0"
							value="0" required="required">無
					</div>
					<div>
						<input name="member_disease_id" type="radio" id="disease_id_1"
							value="1" required="required">先天疾病
					</div>
					<div>
						<input name="member_disease_id" type="radio" id="disease_id_2"
							value="2" required="required">重大傷病
					</div>
					<div>
						<input name="member_disease_id" type="radio" id="disease_id_3"
							value="3x" required="required">其他
					</div>
				</div>

				<div class="input phone_number required">
					<label for="phone_number">電話</label> <input
						name="member_phone_number" maxlength="50" type="text"
						id="phone_number" required="required">
				</div>

				<div class="input address required">
					<label for="address">地址</label> <input name="member_address"
						maxlength="50" type="text" id="address" required="required">
				</div>

				<div class="input manager required" id="manager">
					<label for="manager">此會員是否有管理員權限？</label>
					<div>
						<input name="member_manager" type="radio" id="manager_1" value="1"
							required="required">是
					</div>
					<div>
						<input name="member_manager" type="radio" id="manager_0" value="0"
							required="required">否
					</div>
				</div>


			</form>


			<!-- 按鈕：取消註冊 / 建立帳戶 -->
			<form id="form" accept-charset="utf-8">

				<div class="submit">
					<input type="button" value="取消修改"
						onclick="javascript:history.go(-1)"> <input
						type="button" value="確定修改" id="submit">
					<!--onclick=
            			"location.href='member_center.html'" id="submit">-->
				</div>

			</form>


			<!--
            	
            -->
			<script type="text/javascript">
                // 取得網址參數
                var url_string = window.location.href;
                var url = new URL(url_string);
                var id = url.searchParams.get("ID_number");
                var isManager = localStorage.getItem("isManager");
                var sql_num = 0;
                
                $('#submit').click(function() {
                    updateMember(id)
                });
                
                $(document).ready(function() {
                	
                	if(isManager == 0){
                		document.getElementById('member_bar').style.display = "block";
                		document.getElementById('manager_bar').style.display = "none";
                		document.getElementById('manager').style.display = "none"
                	}else if(isManager == 1){
                		document.getElementById('manager_bar').style.display = "block";
                		document.getElementById('member_bar').style.display = "none";
                		document.getElementById('manager').style.display = "block"
                	}else{	
                		alert("您尚未登入");
                		window.location = "login.html";
                	}
                	
                	// 發出GET的AJAX請求取得原本該會員的資料
                 	$("#sql_log > tbody").empty();
                    getMember();
                });

                function updateMember(id) {
                    var member_name 			= $('#name').val();
                    var member_email 			= $('#email').val();
                    var member_password 		= $('#password').val();
                    var member_bank_account 	= $('#bank_account').val();
                    var member_birthday 		= $('#birthday').val();
                    var member_gender 			= $('input[name=member_gender]:checked').val();
                    var member_height 			= $('#height').val();
                    var member_weight 			= $('#weight').val();
                    var member_disease_id 		= $('input[name=member_disease_id]:checked').val();
                    var member_phone_number 	= $('#phone_number').val();
                    var member_address 		= $('#address').val();
                    var member_manager 		= $('input[name=member_manager]:checked').val();
                    var member_delete_key  = 0; 
                    
                    member_birthday = checkDate(member_birthday);
                    
                    var email_rule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;
                    var password_rule = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
                    
                    
                    if (!email_rule.test(member_email)) {
                        alert("Email格式不符！");
                    }
                    else if(!password_rule.test(member_password)) {
                        alert("密碼格式不符，長度至少8，且至少包含一個數字和英文字母！");
                    }else if(member_birthday == false){
                    	alert("生日格式錯誤");
                    }else {
                        // 將資料組成JSON格式
                        var data_object = {
                        	"ID_number":    id,	
                        	"name":			member_name,
                            "email":		member_email,
                            "password":		member_password,
                            "bank_account":	member_bank_account,
                            "birthday":		member_birthday,
                            "gender":		member_gender,
                            "height":		member_height,
                            "weight":		member_weight,
                            "disease_id":	member_disease_id,
                            "phone_number":	member_phone_number,
                            "address":		member_address,
                            "manager":		member_manager,
                            "delete_key":   member_delete_key
                        };

                        // 將JSON格式轉換成字串
                        var data_string = JSON.stringify(data_object);

                        // 發出POST的PUT請求
                        $.ajax({
                                type: "PUT",
                                url: "api/member.do",
                                data: data_string,
                                crossDomain: true,
                                cache: false,
                                dataType: 'json',
                                timeout: 5000,
                                success: function (response) {
                                    $('#flashMessage').html(response.message);
                                    $('#flashMessage').show();
                                    if(response.status == 200){
                                        window.location = "javascript:history.go(-1)";
                                    }
                                },
                                error: function () {
                                    alert("無法連線到伺服器！");
                                }
                        });
                    }
                }
                
                function getMember() {
                    $.ajax({
                        type: "GET",
                        url: "api/member.do",
                        crossDomain: true,
                        data: "ID_number=" + id,
                        cache: false,
                        dataType: 'json',
                        timeout: 5000,
                        success: function (response) {
                            if(response.status == 200){
                            	document.getElementById('name').value = response['response']['data'][0]['name'];
                            	document.getElementById('email').value = response['response']['data'][0]['email'];
                            	document.getElementById('password').value = response['response']['data'][0]['password'];
                            	document.getElementById('member_password_check').value = response['response']['data'][0]['password'];
                            	document.getElementById('bank_account').value = response['response']['data'][0]['bank_account'];
                            	document.getElementById('birthday').value = response['response']['data'][0]['birthday'];
                            	document.getElementById('gender_'+response['response']['data'][0]['gender']).checked = true;
                            	document.getElementById('height').value = response['response']['data'][0]['height'];
                            	document.getElementById('weight').value = response['response']['data'][0]['weight'];
                            	document.getElementById('disease_id_'+response['response']['data'][0]['disease_id']).checked = true;
                            	document.getElementById('phone_number').value = response['response']['data'][0]['phone_number'];
                            	document.getElementById('address').value = response['response']['data'][0]['address'];
                            	document.getElementById('manager_'+response['response']['data'][0]['manager']).checked = true;

                            }
                            console.log(response);
                        },
                        error: function () {
                            alert("無法連線到伺服器！");
                        }
                    });
                }
                
                /// 檢查輸入的日期是否是一個正確的日期格式:
                /// 支援 yyyy-M-d、yyyy-MM-dd、yyyy/M/d、yyyy/MM/dd 四種輸入格式。

                function checkDate(strInputDate) {
                  // 定義一個月份天數常量陣列
                  var DA = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

                  // 統一日期格式
                  strDate = strInputDate.replace(/-/g, "/");

                  //判斷日期是否是預期的格式
                  if (strDate.indexOf("/") == -1) {
                    alert("請輸入 yyyy-M-d、yyyy-MM-dd、yyyy/M/d、yyyy/MM/dd 格式。")
                    return false;
                  }

                  // 分解出年月日
                  arrD = strDate.split("/");
                  if (arrD.length != 3) return false;
                  y = parseInt(arrD[0], 10);
                  m = parseInt(arrD[1], 10);
                  d = parseInt(arrD[2], 10);

                  //判斷年月日是否是數字
                  if (isNaN(y) || isNaN(m) || isNaN(d)) return false;

                  // 判斷月份是否在1-12之間
                  if (m > 12 || m < 1) return false;
                  //判斷是否是閏年
                  if (isLoopYear(y)) DA[2] = 29;

                  //判斷輸入的日是否超過了當月月份的總天數。
                  if (d > DA[m]) return false;

                  //各種條件都驗證了,則應該是一個合法的日期了。
                  // 如果要對日期進行一次格式化,則可以在這裡進行處理了,下面格式化成資料庫識別的日期格式 yyyy-MM-dd
                  // str = y + "-" + (m<10?"0":"") + m + "-" + (d<10?"0":"") + d;
                  str = y + "-" + (m < 10 ? "0" : "") + m + "-" + (d < 10 ? "0" : "") + d;
                  return str;
                }
                function isLoopYear(theYear) {
                  return (new Date(theYear, 1, 29).getDate() == 29);
                }

            </script>


		</div>

	</div>

</body>


</html>